# Remote Debugging Clojure Web Applications on Microsoft Azure Websites

Clojure can be used to build web applications that can be deployed on Microsoft Azure Websites. Developing the application locally is a great deal of fun with the awesome REPL. The repl is also a highly effective mean to observe the live process and troubleshoot tricky issues. However, once it is deployed to Azure, there is no longer an easy way to access a REPL to the live application. This is a small helper to gain that REPL access again. It is quite simple, but highly effective at troubleshooting the live application even in the production environment without any performance hit.

**It doesn't require any kind of addition or modification to your existing clojure web application.**

A simple REPL can be started on a Clojure application just by one simple java option `-Dclojure.server.repl="{:port 9000 :accept clojure.core.server/repl}"`. With this, Clojure would automatically start a *Socket REPL* on port *9000*. The trick is to make this REPL accessible somehow on your local machine. That is the purpose of this tool.

## Prerequisites

* Azure website with a Clojure (Java) Web Application.
* Enable websockets on your azure web site.
* Change bitness of your webapp to 64bit.
* Install Clojure CLI

## Ensure 64bit and Enable 'web sockets' on your azure website

![enable websocket](./docs/images/websocket-enabled.png "")

## Enable Socket REPL in web.config

The actual method of hosting Clojure app can be different from the example shown here. In that case, you may have to do it a bit differently to ensure this option in *JAVA_OPTS*.

```xml
<httpPlatform
   processPath="%JAVA_HOME%\bin\java.exe"
   arguments="-Djava.net.preferIPv4Stack=true
              -Dclojure.server.repl=&quot;{:port %HTTP_PLATFORM_DEBUG_PORT% :accept clojure.core.server/repl}&quot;
              -cp d:\home\site\wwwroot\src;d:\home\site\wwwroot\lib\*;d:\home\site\wwwroot\resources
              clojure.main
              -e &quot;(do (require (quote my-app.core)) (my-app.core/start))&quot;">
</httpPlatform>
```

Or

```xml
<httpPlatform>
   <environmentVariables>
      <environmentVariable
         name="JAVA_OPTS"
         value="-Djava.net.preferIPv4Stack=true
                -Dclojure.server.repl=&quot;{:port %HTTP_PLATFORM_DEBUG_PORT% :accept clojure.core.server/repl}&quot;"/>
   </environmentVariables>
</httpPlatform>
```

NOTE: *%HTTP_PLATFORM_DEBUG_PORT%* is a special placeholder which will be replaced with a port internally generated by the *HttpPlatformHandler* module.

Restart your azure website after editing the web.config.

## Gather azure web application connection info

To access the REPL this tool connects to the azure app service scm endpoint and establishes a websocket. It would need the credentials for authentication. You need to obtain those credentials for your azure web application from Azure Portal.

In the Azure Portal, in the *Overview* blade, click *Get publish profile*. This would download a *.PublishSettings* file. Note the *username* and *password* associated with the `MSDeploy` publishMethod.

## Install Clojure CLI

Install it from the official site [Clojure.org](https://clojure.org/guides/getting_started "Getting started with Clojure CLI")

## Add a new alias for this tool to your global *deps.edn* file

```clojure
  :aliases {
     :az-ws-debug {:extra-deps {az.ws-debug {:git/url "https://github.com/paroda/az-ws-debug"
                                             :sha "01977cebbbd200672fe1443ceb88f79a1b304f90"}}}
  }
```

## Access the remote REPL

Start the tool

```text
> clojure -A:az-ws-debug
Clojure 1.10.1
user=>
```

### Load and connect

To connect call the function `az.ws-debug/connect`. It takes a map with 3 keys:

* `:az-app-name`: the name of your azure webapp. for example, for the web app `https://my-app.azurewebsites.net` the app-name is `my-app`
* `:user-name`: the username as obtained from the PublishSettings for `MSDeploy` publishMethod
* `:password`: the password as obtained from the PublishSettings for `MSDeploy` publishMethod

Then call `az.ws-debug/repl` to access the remote *Socket REPL*

```text
user=> (require '[az.ws-debug :as dbg])
nil
user=> (dbg/connect {:az-app-name "azure-app-name"
                     :user-name "user-name"
                     :password "password"})
20-03-28 17:12:43 localhost.localdomain INFO [az.ws-debug:17] - session ready
20-03-28 17:12:43 localhost.localdomain INFO [az.ws-debug:77] - session connected
nil
user=> (dbg/repl)
20-03-28 17:13:56 localhost.localdomain INFO [az.ws-debug:45] - repl started
=>
```

Now you are connected to the **Socket REPL** on the remote clojure process running on Azure web site. You can interact with it as you would with a locally running REPL. You can dig deeper into the live process on the production environment without disturbing it. For example, you can check the actual environment variables in effect. You can check the state atoms. All sorts of things you are used to while doing local development.

```text
user=> (System/getenv "HTTP_PLATFORM_PORT")
"16408"  ;; quickly check the actual port set by azure web site
user=> (System/getProperty "java.vm.name")
"OpenJDK 64-Bit Server VM"
user=> (System/getProperty "sun.boot.library.path")
"D:\\Program Files\\Java\\zulu8.36.0.1-jre8.0.202-win_x64\\bin"
user=>
```

To close the repl type `:repl/quit`

```text
user=> :repl/quit
20-03-28 17:32:53 localhost.localdomain INFO [az.ws-debug:53] - repl closed!
nil
user=>
```

To disconnect the websocket type `(az.ws-debug/close)`

```text
user=> (dbg/close)
20-03-28 17:34:50 localhost.localdomain INFO [az.ws-debug:42] - session closed: 1006 Disconnected
nil
user=>
```

## How it works

Azure web site provides an option for remote debugging Java application through a websocket connection. However, it assumes that the communication throught this websocket would be [Java Debug Wire Protocol](https://docs.oracle.com/javase/8/docs/technotes/guides/jpda/jdwp-spec.html). And, it checks the first JDWP handshake. However, after that it just passes the raw data as is.

Here, we utilize that websocket connection. To satisfy the initial handshake check, it first sends a 14 byte message "JDWP-Handshake". Otherwise, the remote system would consider it invalid and abort the connection. Once the first handshake is done, the rest is straight forward. Just simple plain text transfer. And so we got the remote Socket REPL on local machine.

## Limitation

This is meant for troubleshooting purpose, for which the simple text repl is quite adequate. It is not meant for integration to IDE as that would require more tooling support. Maybe implement the n-REPL through websocket. However, that would need some additional dependencies to be part of your deployment to Azure web site. And the goal of this tool is not to add any extra development libraries into the production environment. It is primarily meant for those edge case issues, which only occur on the Azure environment and not reproducible during local development.

If adding the extra library is okay, then there are a few nice tools already. For example: [Drawbridge](https://github.com/nrepl/drawbridge)

## CAUTION

You must realize that you are connecting to the live system and be careful with what you do. You would be making changes which would be effective immediately for all.

This is still in alpha stage. There might be issues.
